-- ================================================================
-- 1. DATABASE: order_db
-- ================================================================

-- Xóa bảng cũ để reset sạch
DROP TABLE IF EXISTS "OrderItems";
DROP TABLE IF EXISTS "Orders";

-- Tạo bảng Đơn hàng (CÓ CỘT TableId)
CREATE TABLE "Orders" (
    "Id" SERIAL PRIMARY KEY,
    "TableId" INT NOT NULL DEFAULT 0,         -- [QUAN TRỌNG] ID bàn ăn
    "TableName" VARCHAR(100) NOT NULL,        -- Tên bàn hiển thị
    "TotalAmount" DECIMAL(18, 2) NOT NULL DEFAULT 0,
    "Status" VARCHAR(50) DEFAULT 'Pending',   -- Pending, Cooking, Completed, Paid
    "TenantId" INT NOT NULL DEFAULT 0,        -- Mã nhà hàng
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tạo bảng Chi tiết đơn hàng
CREATE TABLE "OrderItems" (
    "Id" SERIAL PRIMARY KEY,
    "MenuItemName" VARCHAR(200) NOT NULL,
    "Price" DECIMAL(18, 2) NOT NULL,
    "Quantity" INT NOT NULL DEFAULT 1,
    "Note" TEXT NULL,
    "OrderId" INT NOT NULL,

    CONSTRAINT fk_order
      FOREIGN KEY ("OrderId") 
      REFERENCES "Orders"("Id")
      ON DELETE CASCADE
);

-- Tạo Index tìm kiếm nhanh
CREATE INDEX "IX_Orders_TenantId" ON "Orders" ("TenantId");

-- Thêm dữ liệu mẫu (1 đơn hàng tại Bàn 1)
INSERT INTO "Orders" ("TableId", "TableName", "TotalAmount", "Status", "TenantId", "CreatedAt")
VALUES (1, 'Bàn 1 (Demo)', 150000, 'Pending', 1, NOW());

INSERT INTO "OrderItems" ("MenuItemName", "Price", "Quantity", "Note", "OrderId")
VALUES 
('Phở Bò Tái', 55000, 2, 'Không hành', (SELECT "Id" FROM "Orders" LIMIT 1)),
('Trà Đá', 5000, 4, '', (SELECT "Id" FROM "Orders" LIMIT 1));
================================================================================================================================================================================================================================================================

-- ================================================================
-- 2. DATABASE: menu_db
-- ================================================================

-- Xóa bảng cũ
DROP TABLE IF EXISTS "MenuItems";
DROP TABLE IF EXISTS "Categories";
DROP TABLE IF EXISTS "Tables";

-- Tạo bảng Danh mục
CREATE TABLE "Categories" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(100) NOT NULL
);

-- Tạo bảng Món ăn (Ảnh dùng link placehold.co cho ổn định)
CREATE TABLE "MenuItems" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(200) NOT NULL,
    "Price" DECIMAL(18, 2) NOT NULL,
    "CategoryId" INT NOT NULL,
    "Description" TEXT NULL,
    "ImageUrl" TEXT NULL,
    "IsAvailable" BOOLEAN DEFAULT TRUE,
    "TenantId" INT NOT NULL DEFAULT 0,
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_category FOREIGN KEY ("CategoryId") REFERENCES "Categories"("Id") ON DELETE SET NULL
);
CREATE INDEX "IX_MenuItems_TenantId" ON "MenuItems" ("TenantId");

-- Tạo bảng Bàn ăn
CREATE TABLE IF NOT EXISTS "Tables" (
    "Id" SERIAL PRIMARY KEY,
    "Name" VARCHAR(50) NOT NULL,          
    "Status" VARCHAR(20) DEFAULT 'Available', 
    "CurrentOrderId" INT NULL,            
    "TenantId" INT NOT NULL DEFAULT 0,    
    "CreatedAt" TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX "IX_Tables_TenantId" ON "Tables" ("TenantId");

-- Thêm dữ liệu Danh mục
INSERT INTO "Categories" ("Name") VALUES 
('Món nước'), ('Món khô'), ('Đồ uống'), ('Tráng miệng'), ('Khác');

-- Thêm dữ liệu Món ăn (TenantId = 1)
INSERT INTO "MenuItems" ("Name", "Price", "CategoryId", "Description", "ImageUrl", "IsAvailable", "TenantId") VALUES 
('Phở Bò Tái', 55000, 1, 'Phở bò tái truyền thống', 'https://placehold.co/150', TRUE, 1),
('Cơm Tấm Sườn', 60000, 2, 'Sườn nướng mật ong', 'https://placehold.co/150', TRUE, 1),
('Trà Đào', 35000, 3, 'Trà đào cam sả', 'https://placehold.co/150', TRUE, 1);

-- Thêm dữ liệu Bàn ăn (TenantId = 1)
INSERT INTO "Tables" ("Name", "Status", "TenantId") VALUES 
('Bàn 1', 'Available', 1),
('Bàn 2', 'Available', 1),
('Bàn 3', 'Available', 1),
('Bàn 4', 'Available', 1),
('Bàn VIP 1', 'Available', 1);
CSDL CHO MENU
-- ===============================
-- DATA CHO 3 NHÀ HÀNG (TENANT 2,3,4)
-- ===============================

-- ========= TENANT 2: QUÁN BÚN – MÌ =========
INSERT INTO "MenuItems"
("Name", "Price", "CategoryId", "Description", "ImageUrl", "IsAvailable", "TenantId")
VALUES
('Bún Bò Huế', 50000, 1, 'Bún bò Huế cay nhẹ', 'https://via.placeholder.com/150', TRUE, 2),
('Mì Quảng Gà', 45000, 1, 'Mì Quảng gà ta', 'https://via.placeholder.com/150', TRUE, 2),
('Bún Chả Hà Nội', 55000, 2, 'Bún chả nướng than', 'https://via.placeholder.com/150', TRUE, 2),
('Nước Sâm', 20000, 3, 'Nước sâm thảo mộc', 'https://via.placeholder.com/150', TRUE, 2);

INSERT INTO "Tables" ("Name", "Status", "TenantId") VALUES
('Bàn 1', 'Available', 2),
('Bàn 2', 'Available', 2),
('Bàn 3', 'Available', 2),
('Bàn 4', 'Available', 2);

-- ========= TENANT 3: CƠM GIA ĐÌNH =========
INSERT INTO "MenuItems"
("Name", "Price", "CategoryId", "Description", "ImageUrl", "IsAvailable", "TenantId")
VALUES
('Cơm Gà Xối Mỡ', 60000, 2, 'Gà chiên giòn ăn kèm cơm', 'https://via.placeholder.com/150', TRUE, 3),
('Cơm Cá Kho Tộ', 55000, 2, 'Cá kho tộ đậm vị', 'https://via.placeholder.com/150', TRUE, 3),
('Canh Chua Cá', 40000, 1, 'Canh chua miền Tây', 'https://via.placeholder.com/150', TRUE, 3),
('Trà Chanh', 15000, 3, 'Trà chanh mát lạnh', 'https://via.placeholder.com/150', TRUE, 3);

INSERT INTO "Tables" ("Name", "Status", "TenantId") VALUES
('Bàn 1', 'Available', 3),
('Bàn 2', 'Available', 3),
('Bàn 3', 'Available', 3),
('Bàn 4', 'Available', 3);

-- ========= TENANT 4: CAFE – TRÀ SỮA =========
INSERT INTO "MenuItems"
("Name", "Price", "CategoryId", "Description", "ImageUrl", "IsAvailable", "TenantId")
VALUES
('Cafe Sữa Đá', 25000, 3, 'Cafe phin truyền thống', 'https://via.placeholder.com/150', TRUE, 4),
('Bạc Xỉu', 30000, 3, 'Bạc xỉu ngọt dịu', 'https://via.placeholder.com/150', TRUE, 4),
('Trà Sữa Trân Châu', 35000, 3, 'Trà sữa truyền thống', 'https://via.placeholder.com/150', TRUE, 4),
('Bánh Flan', 20000, 4, 'Bánh flan trứng sữa', 'https://via.placeholder.com/150', TRUE, 4);

INSERT INTO "Tables" ("Name", "Status", "TenantId") VALUES
('Bàn 1', 'Available', 4),
('Bàn 2', 'Available', 4),
('Bàn 3', 'Available', 4),
('Bàn 4', 'Available', 4);
================================================================================================================================================================================================
-- ================================================================
-- 3. DATABASE: auth_db
-- ================================================================

-- Xóa bảng cũ
DROP TABLE IF EXISTS "Users";
DROP TABLE IF EXISTS "Tenants";

-- Tạo bảng Nhà Hàng
CREATE TABLE IF NOT EXISTS "Tenants" (
    "Id" SERIAL PRIMARY KEY,
    "Name" TEXT NOT NULL,
    "Address" TEXT,
    "IsActive" BOOLEAN DEFAULT TRUE,
    "CreatedAt" TIMESTAMP DEFAULT NOW()
);

-- Tạo bảng Users
CREATE TABLE IF NOT EXISTS "Users" (
    "Id" SERIAL PRIMARY KEY,
    "Username" TEXT NOT NULL,
    "PasswordHash" TEXT NOT NULL,
    "FullName" TEXT,
    "Role" TEXT NOT NULL,
    "PhoneNumber" TEXT,
    "Points" INTEGER DEFAULT 0,
    "TenantId" INTEGER REFERENCES "Tenants"("Id"),
    "CreatedAt" TIMESTAMP DEFAULT NOW()
);

-- 1. Tạo Nhà Hàng (Chắc chắn ID sẽ là 1 vì vừa DROP xong)
INSERT INTO "Tenants" ("Name", "Address", "IsActive", "CreatedAt")
VALUES ('Nhà Hàng Demo', '123 Đường Mẫu, TP.HCM', true, NOW());

-- 2. Tạo User (Admin, Owner, Khách)
INSERT INTO "Users" ("Username", "PasswordHash", "FullName", "Role", "TenantId", "PhoneNumber", "Points", "CreatedAt")
VALUES 
('admin1', '$2b$10$KqCaahb1QGAbwsDsIb.vSuTCmNC7M7G3lWnWi.xh2z7RBBOM7WILC', 'Admin Chính', 'Admin', NULL, '0901000001', 0, NOW()),
('owner_demo', '$2b$10$KqCaahb1QGAbwsDsIb.vSuTCmNC7M7G3lWnWi.xh2z7RBBOM7WILC', 'Chủ Quán Demo', 'Owner', 1, '0909999999', 0, NOW()),
('khachhang1', '$2b$10$KqCaahb1QGAbwsDsIb.vSuTCmNC7M7G3lWnWi.xh2z7RBBOM7WILC', 'Khách VIP', 'Customer', NULL, '0908888888', 100, NOW());
ALTER TABLE "Tenants" ADD COLUMN IF NOT EXISTS "LogoUrl" text;
ALTER TABLE "Tenants" ADD COLUMN IF NOT EXISTS "OwnerName" text;
ALTER TABLE "Tenants" ADD COLUMN IF NOT EXISTS "UpdatedAt" timestamp with time zone;
-- Thêm cột mới vào bảng Tenants để lưu thông tin chủ sở hữu
ALTER TABLE "Tenants" 
ADD COLUMN "OwnerName" TEXT,
ADD COLUMN "PhoneNumber" TEXT,
ADD COLUMN "UpdatedAt" TIMESTAMP;

-- Cập nhập dữ liệu demo có thông tin chủ sở hữu
UPDATE "Tenants" 
SET "OwnerName" = 'Chủ Quán Demo', "PhoneNumber" = '0909999999' 
WHERE "Id" = 1;